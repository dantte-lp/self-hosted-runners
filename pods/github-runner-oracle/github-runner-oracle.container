# Systemd Quadlet Container Unit for GitHub Actions Runner (Oracle Linux)
# Location: /etc/containers/systemd/github-runner-oracle.container
#
# This file defines a Podman container managed by systemd using quadlets.
# See: https://docs.podman.io/en/latest/markdown/podman-systemd.unit.5.html
#
# Installation:
#   sudo cp github-runner-oracle.container /etc/containers/systemd/
#   sudo systemctl daemon-reload
#   sudo systemctl start github-runner-oracle.service
#   sudo systemctl enable github-runner-oracle.service  # Auto-start on boot

[Unit]
Description=GitHub Actions Self-Hosted Runner (Oracle Linux 10)
Documentation=https://github.com/dantte-lp/self-hosted-runners
After=network-online.target
Wants=network-online.target

[Container]
# Container image (local build or registry)
Image=localhost/github-runner-oracle:latest

# Container name
ContainerName=github-runner-oracle

# Hostname inside container
HostName=github-runner-oracle

# Auto-update container image
# Options: registry, local, disabled
AutoUpdate=disabled

# Pull policy
# Options: always, missing, never, newer
Pull=missing

# ════════════════════════════════════════════════════════════════════
# Environment Variables
# ════════════════════════════════════════════════════════════════════

# Load environment from file (create this from env.example)
EnvironmentFile=/opt/projects/repositories/self-hosted-runners/pods/shared/.env

# Override specific variables (optional)
Environment=RUNNER_NAME=oraclelinux-runner-ocserv-agent
Environment=RUNNER_LABELS=self-hosted,linux,x64,oracle-linux,rpm-build,mock,podman,el10

# Podman configuration for nested containers
Environment=BUILDAH_ISOLATION=chroot
Environment=STORAGE_DRIVER=vfs

# ════════════════════════════════════════════════════════════════════
# Volumes and Mounts
# ════════════════════════════════════════════════════════════════════

# Mount project directory for builds (read-write)
Volume=/opt/projects/repositories:/workspace:rw,z

# Mount Podman socket for podman-in-podman
# This allows RPM builds with mock that use containers
Volume=/run/podman/podman.sock:/run/podman/podman.sock:rw

# Optional: Mount mock cache for faster RPM builds
# Volume=/var/cache/mock:/var/cache/mock:rw,z

# ════════════════════════════════════════════════════════════════════
# Networking
# ════════════════════════════════════════════════════════════════════

# Network mode
# Options: bridge, host, none, container:name, ns:path
Network=bridge

# Publish ports (if needed)
# PublishPort=8080:8080

# ════════════════════════════════════════════════════════════════════
# Security and Capabilities
# ════════════════════════════════════════════════════════════════════

# Security options
# Disable SELinux confinement (required for mock and container builds)
SecurityLabelDisable=true

# Add capabilities (required for mock and container builds)
# AddCapability=SYS_ADMIN
# AddCapability=MKNOD

# User namespace mode
# Options: auto, host, keep-id, nomap, container:id
UserNS=auto

# ════════════════════════════════════════════════════════════════════
# Resource Limits
# ════════════════════════════════════════════════════════════════════

# CPU quota (percentage of one CPU core, e.g., 400% = 4 cores)
# Limit to 4 cores max for this runner
# CPUQuota=400%

# Memory limit (recommended: 8GB for RPM builds with mock)
# Memory=8G
# MemorySwap=8G

# ════════════════════════════════════════════════════════════════════
# Logging
# ════════════════════════════════════════════════════════════════════

# Log driver
# Options: journald, k8s-file, json-file, none
LogDriver=journald

# ════════════════════════════════════════════════════════════════════
# Runtime Options
# ════════════════════════════════════════════════════════════════════

# Timezone
Timezone=local

# Tmpfs mounts (for temporary build files - mock uses a lot of tmpfs)
Tmpfs=/tmp:rw,noexec,nosuid,size=4G

# ════════════════════════════════════════════════════════════════════
# Systemd Integration
# ════════════════════════════════════════════════════════════════════

# Notify systemd when container is ready
# Notify=healthy

# Health check (check if runner is responsive)
# HealthCmd=/bin/sh -c "test -f /home/runner/.runner"
# HealthInterval=30s
# HealthTimeout=10s
# HealthRetries=3

[Service]
# Restart policy
Restart=always
RestartSec=10s

# Timeout for start/stop operations
TimeoutStartSec=300
TimeoutStopSec=60

# ════════════════════════════════════════════════════════════════════
# Resource Limits (Systemd Level)
# ════════════════════════════════════════════════════════════════════

# CPU quota (systemd manages this)
# CPUQuota=400%

# Memory limits (systemd manages this)
# MemoryMax=8G
# MemoryHigh=7G

# IO weight (100 = default, 10-1000 range)
# IOWeight=100

[Install]
WantedBy=multi-user.target default.target
